From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: DenaryDev <denaryplanet@gmail.com>
Date: Fri, 11 Feb 2022 00:38:44 +0500
Subject: [PATCH] Chromium client support


diff --git a/src/main/java/io/sapphiremc/sapphire/SapphireCommand.java b/src/main/java/io/sapphiremc/sapphire/SapphireCommand.java
index c337948c82263af20e55570a2c65288aa0123334..e59f4a767d04046404c266bafba4ccc400dea306 100644
--- a/src/main/java/io/sapphiremc/sapphire/SapphireCommand.java
+++ b/src/main/java/io/sapphiremc/sapphire/SapphireCommand.java
@@ -7,6 +7,7 @@ import org.bukkit.Bukkit;
 import org.bukkit.Location;
 import org.bukkit.command.Command;
 import org.bukkit.command.CommandSender;
+import org.bukkit.entity.Player;
 import org.jetbrains.annotations.NotNull;
 import org.jetbrains.annotations.Nullable;
 
@@ -63,6 +64,22 @@ public class SapphireCommand extends Command {
                     sender.sendMessage(prefix + "Sapphire config reload complete, but some functions need you to restart the server.");
                 }
             }
+            case "isChromium" -> {
+                if (args.length == 2) {
+                    Player player = Bukkit.getServer().getPlayer(args[1]);
+                    if (player != null) {
+                        if (player.usesChromiumClient()) {
+                            sender.sendMessage(prefix + "Player %s is using chromium client".formatted(args[1]));
+                        } else {
+                            sender.sendMessage(prefix + "Player %s isn't using chromium client".formatted(args[1]));
+                        }
+                    } else {
+                        sender.sendMessage(prefix + "Player %s is null".formatted(args[1]));
+                    }
+                } else {
+                    sender.sendMessage(prefix + "Usage: /sapphire isChromium <name>");
+                }
+            }
             case "ver", "version" -> {
                 if (args.length == 1) {
                     sender.sendMessage(prefix + "This server is running " + Bukkit.getName() + " version " + Bukkit.getVersion() + " (Git: " + getGitInfo() + ")");
@@ -74,7 +91,7 @@ public class SapphireCommand extends Command {
         return true;
     }
 
-    private final Collection<String> allAliases = Set.of("reload", "version", "ver");
+    private final Collection<String> allAliases = Set.of("reload", "isChromium", "version", "ver");
 
     @Override
     public @NotNull List<String> tabComplete(@NotNull CommandSender sender, @NotNull String alias, @NotNull String[] args, @Nullable Location location) throws IllegalArgumentException {
@@ -92,6 +109,20 @@ public class SapphireCommand extends Command {
                     .toList()
                 );
             }
+        } else if (args.length == 2) {
+            if (args[0].isEmpty()) {
+                aliases.addAll(Bukkit.getOnlinePlayers().stream()
+                    .map(Player::getName)
+                    .toList()
+                );
+            } else {
+                String arg = args[1];
+                aliases.addAll(Bukkit.getOnlinePlayers().stream()
+                    .map(Player::getName)
+                    .filter(s -> s.contains(arg))
+                    .toList()
+                );
+            }
         }
 
         return aliases;
diff --git a/src/main/java/net/minecraft/server/level/ServerPlayer.java b/src/main/java/net/minecraft/server/level/ServerPlayer.java
index e0e133ab39548b8e671441e3383a6f4df6f6997e..cc8a6949bd372f2ee37cdbd969ab2728811ce339 100644
--- a/src/main/java/net/minecraft/server/level/ServerPlayer.java
+++ b/src/main/java/net/minecraft/server/level/ServerPlayer.java
@@ -282,6 +282,7 @@ public class ServerPlayer extends Player {
     private boolean ramBar = false; // Purpur
     private boolean tpsBar = false; // Purpur
     private boolean compassBar = false; // Purpur
+    public boolean chromiumClient = false; // Sapphire
 
     private final java.util.concurrent.atomic.AtomicReference<io.papermc.paper.chunk.system.RegionizedPlayerChunkLoader.ViewDistances> viewDistances = new java.util.concurrent.atomic.AtomicReference<>(new io.papermc.paper.chunk.system.RegionizedPlayerChunkLoader.ViewDistances(-1, -1, -1));
     public io.papermc.paper.chunk.system.RegionizedPlayerChunkLoader.PlayerChunkLoaderData chunkLoader;
diff --git a/src/main/java/net/minecraft/server/network/ServerGamePacketListenerImpl.java b/src/main/java/net/minecraft/server/network/ServerGamePacketListenerImpl.java
index e76eaa121f73cc56b0e3445eb976546daef87f99..3259112476d1d9f350e14c28069469bc6407d2c5 100644
--- a/src/main/java/net/minecraft/server/network/ServerGamePacketListenerImpl.java
+++ b/src/main/java/net/minecraft/server/network/ServerGamePacketListenerImpl.java
@@ -3619,6 +3619,7 @@ public class ServerGamePacketListenerImpl implements ServerPlayerConnection, Tic
 
     private static final ResourceLocation MINECRAFT_BRAND = new ResourceLocation("brand"); // Paper - Brand support
     private static final ResourceLocation PURPUR_CLIENT = new ResourceLocation("purpur", "client"); // Purpur
+    private static final ResourceLocation CHROMIUM_CLIENT = new ResourceLocation("chromium", "client"); // Sapphire
 
     @Override
     public void handleCustomPayload(ServerboundCustomPayloadPacket packet) {
@@ -3650,6 +3651,13 @@ public class ServerGamePacketListenerImpl implements ServerPlayerConnection, Tic
             } catch (Exception ignore) {
             }
         // Purpur end
+        // Sapphire start
+        } else if (packet.identifier.equals(CHROMIUM_CLIENT)) {
+            try {
+                player.chromiumClient = true;
+            } catch (Exception ignored) {
+            }
+        // Sapphire end
         } else {
             try {
                 byte[] data = new byte[packet.data.readableBytes()];
diff --git a/src/main/java/org/bukkit/craftbukkit/entity/CraftPlayer.java b/src/main/java/org/bukkit/craftbukkit/entity/CraftPlayer.java
index 3d2c4ba68b1fdc10d7592164e1fab9b3a6458187..485b16e94ca5b36baa914766a9401d4c06bd3a64 100644
--- a/src/main/java/org/bukkit/craftbukkit/entity/CraftPlayer.java
+++ b/src/main/java/org/bukkit/craftbukkit/entity/CraftPlayer.java
@@ -3268,4 +3268,11 @@ public class CraftPlayer extends CraftHumanEntity implements Player {
         this.getHandle().connection.send(new net.minecraft.network.protocol.game.ClientboundPlayerCombatKillPacket(getEntityId(), io.papermc.paper.adventure.PaperAdventure.asVanilla(message)));
     }
     // Purpur end
+
+    // Sapphire start
+    @Override
+    public boolean usesChromiumClient() {
+        return getHandle().chromiumClient;
+    }
+    // Sapphire end
 }
